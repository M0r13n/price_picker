{% extends "main/_base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% from "_macros.html" import render_repair with context %}

{% block sub_page %}
    <div class="container">
        <div class="row">
            {% for repair in repairs %}
                {{ render_repair(repair) }}
            {% endfor %}

            <!-- Always include an arbitrary choice-->
            <div class="col-sm-4 py-2 text-center">
                <div class="card h-100">
                    <div class="card-header">
                        <h4 class="my-0 font-weight-normal">Sonstige</h4>
                    </div>
                    <div class="card-body">
                        Preis auf Anfrage
                    </div>
                </div>
            </div>

            <!-- Always include an add option if admin is logged in-->
            {% if current_user.is_authenticated %}
                <div class="col-sm-4 py-2 text-center" id="newRepair">
                    <div class="card bg-primary h-100">
                        <div class="card-body text-white align-items-center d-flex justify-content-center">
                            <h1>Neu</h1>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
        <br>

        <!-- Store selected repairs inside a hidden form -->
        <form class="form" role="form" method="post" id="repairSubmitForm">
            <div class="text-center">
                {{ form.hidden_tag() }}
                {{ form.repairs(hidden=True) }}
                <input class="btn btn-success btn-block col-md-4 offset-md-4" type="submit" name="estimate"
                       value="Kostenvoranschlag anfordern">
                <input class="btn btn-success btn-block col-md-4 offset-md-4" type="submit" name="order"
                       value="Zahlungspflichtig bestellen">
            </div>
        </form>
        <br>
        <a class="btn btn-secondary" href="{{ url_for('main.select_device', manufacturer_id=device.manufacturer.id) }}">&laquo;
            Zur√ºck</a>
    </div>

    {% if current_user.is_authenticated %}
        <!-- Add/Edit Modal-->
        <div class="modal fade" id="repairModal" tabindex="-1" role="dialog" aria-labelledby="repairModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="repairModalLabel">Reparatur anpassen</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Load form from view function-->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Abbrechen</button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block js %}
    <script>
        $(document).ready(function () {

            {% if current_user.is_authenticated %}
                /* Fill the modals body with the html returned by the view function. */
                $('.editBtn').click(function () {
                    let url = '/admin/repair/' + $(this).data('id') + '/edit';
                    $.get(url, function (resp) {
                        $('#repairModal .modal-body').html(resp);
                        $('#repairModal').modal('show');
                    })
                });
            {% endif %}

            /* Toggle selected cards and store the information about by card is selected in the hidden form. */
            $('.selectable').click(function () {
                $(this).toggleClass('border-primary');
                let selected_repair_ids = $('.card.border-primary').map(function () {
                    return $(this).data('id');
                }).get();
                $('#repairs').val(selected_repair_ids);
            });

            /* Adds a new empty repair */
            $('#newRepair').click(function () {
                let url = '{{ url_for('admin.add_repair', device_id=device.id) }}';
                $.get(url, function () {
                    location.reload();
                })
            });
        });
    </script>
{% endblock %}